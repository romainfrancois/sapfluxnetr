---
title: "Memory and Parallelization"
author: "Victor Granda (Sapfluxnet Team)"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Memory and Parallelization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

In order to be able to work with the whole database at the *sapwood* or *plant*
level it is recommended at least $16GB$ of RAM memory. This is because loading
all data objects already consumes $4GB$ and any operation like aggregation or
metric calculation results in extra memory needed:

```{r memory_all, eval=FALSE}
library(sapfluxnetr)
library(tidyverse)

# This will need at least 5GB of memory during the process
folder <- 'test_suite/plant'
sfn_metadata <- read_sfn_metadata(folder)

daily_results <- filter_by_var(
    si_biome %in% c("Temperate forest", 'Mediterranean'),
    folder = folder, .use_cache = TRUE
  ) %>%
  read_sfn_data(folder) %>%
  daily_metrics(tidy = TRUE, metadata = sfn_metadata)

# Important to save, this way you will have access to the object in the future
save(daily_results, file = 'daily_results.RData')
```

To circumvent this in less powerful systems, we recommend to work in small
subsets of sites (25-30) and join the tidy results afterwards:

```{r memory_steps, eval = FALSE}
library(sapfluxnetr)
library(tidyverse)

folder <- 'test_suite/plant'
metadata <- read_sfn_metadata(folder)
sites <- filter_by_var(
    si_biome %in% c("Temperate forest", 'Mediterranean'),
    folder = folder, .use_cache = TRUE
  )

daily_results_1 <- read_sfn_data(sites[1:30], folder) %>%
  daily_metrics(tidy = TRUE, metadata = sfn_metadata)
daily_results_2 <- read_sfn_data(sites[31:60], folder) %>%
  daily_metrics(tidy = TRUE, metadata = sfn_metadata)
daily_results_3 <- read_sfn_data(sites[61:90], folder) %>%
  daily_metrics(tidy = TRUE, metadata = sfn_metadata)
daily_results_4 <- read_sfn_data(sites[91:110], folder) %>%
  daily_metrics(tidy = TRUE, metadata = sfn_metadata)

daily_results <- bind_rows(
  daily_results_1, daily_results_2,
  daily_results_3, daily_results_4
)

rm(daily_results_1, daily_results_2, daily_results_3, daily_results_4)
save(daily_results, file = 'daily_results_steps.RData')
```

